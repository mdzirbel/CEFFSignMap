<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>2FA Code with Password Storage</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f0f0f0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .container {
        background: #fff;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        text-align: center;
        width: 350px;
      }
      .password-section {
        margin-bottom: 20px;
      }
      .slider-container {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .slider-label {
        margin-right: 10px;
      }
      /* Slider styling */
      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #007bff;
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }

      .password-label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .password-input {
        font-size: 1rem;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
      }

      .title {
        font-size: 1.2rem;
        margin-bottom: 10px;
        font-weight: bold;
      }

      /* We'll keep the code text and progress bar separate for simpler reloading. */
      .code-box {
        font-size: 1.8rem;
        font-weight: bold;
        border: 2px dashed #ddd;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 40px; /* a bit of height even when empty */
        margin-bottom: 10px;
        width: 100%;
        box-sizing: border-box;
        cursor: pointer; /* Cursor changes on hover */
        position: relative;
      }
      .code-box:hover {
        background-color: #fafafa;
      }

      /* Progress bar sits at the bottom of the code box */
      .progress-container {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 5px;
        width: 100%;
        background-color: #ddd;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        width: 100%;
        background-color: #007bff;
        transition: width 0.3s linear;
      }

      .button-row {
        margin-top: 10px;
      }
      .copy-button,
      .reload-button {
        background-color: #007bff;
        color: #fff;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 0 5px;
      }
      .copy-button:hover,
      .reload-button:hover {
        background-color: #0056b3;
      }
      .reload-button svg {
        width: 24px;
        height: 24px;
      }

      /* Simple fade-in style for user feedback */
      .fade-in {
        animation: fadeIn 0.3s forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="container">

      <!-- Password storage toggle + input -->
      <div class="password-section">
        <div class="slider-container">
          <span class="slider-label">Store Password?</span>
          <label class="switch">
            <input type="checkbox" id="storePasswordSlider" />
            <span class="slider"></span>
          </label>
        </div>
        <label class="password-label" for="passwordInput">Password</label>
        <input
          type="password"
          id="passwordInput"
          class="password-input"
          placeholder="Enter Password"
        />
      </div>

      <!-- Title above the code -->
      <div class="title" id="codeTitle">
        Your Two-Factor Authentication Code
      </div>

      <!-- The code box (clickable). We keep a nested <span> to easily set its textContent -->
      <div class="code-box fade-in" id="codeBox">
        <span id="codeText"></span>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
      </div>

      <!-- Copy and reload buttons below -->
      <div class="button-row">
        <button class="copy-button" id="copyBtn" title="Copy Code">
          Copy
        </button>
        <button class="reload-button" id="reloadBtn" title="Regenerate Code">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round"
               stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 9A8.63 8.63 0 1 0 21 16.86"></path>
          </svg>
        </button>
      </div>
    </div>

    <script>
      /*******************
       * DOM ELEMENTS
       *******************/
      const codeBox             = document.getElementById("codeBox");
      const codeText            = document.getElementById("codeText");
      const progressBarElement  = document.getElementById("progressBar");
      const reloadBtn           = document.getElementById("reloadBtn");
      const copyBtn             = document.getElementById("copyBtn");
      const storePasswordSlider = document.getElementById("storePasswordSlider");
      const passwordInput       = document.getElementById("passwordInput");

      /*******************
       * LOCAL STORAGE
       *******************/
      // On page load, read local storage for slider state & stored password
      const storedSliderState = localStorage.getItem("storePasswordEnabled");
      if (storedSliderState === "true") {
        storePasswordSlider.checked = true;
        passwordInput.value = localStorage.getItem("storedPassword") || "";
      } else {
        storePasswordSlider.checked = false;
      }

      // Keep local storage in sync
      storePasswordSlider.addEventListener("change", () => {
        if (storePasswordSlider.checked) {
          localStorage.setItem("storePasswordEnabled", "true");
          localStorage.setItem("storedPassword", passwordInput.value);
        } else {
          localStorage.setItem("storePasswordEnabled", "false");
          localStorage.removeItem("storedPassword");
        }
      });

      passwordInput.addEventListener("input", () => {
        if (storePasswordSlider.checked) {
          localStorage.setItem("storedPassword", passwordInput.value);
        }
      });

      /*******************
       * 2FA TIMER
       *******************/
      const TIME_STEP = 30; // 30 seconds for standard TOTP intervals
      let timeLeft    = TIME_STEP;
      let countdownInterval;

      function startTimer() {
        // Clear any old interval
        clearInterval(countdownInterval);

        timeLeft = TIME_STEP;
        updateProgressBar(timeLeft);

        countdownInterval = setInterval(() => {
          timeLeft--;
          updateProgressBar(timeLeft);

          if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            callLambda(); // Automatically refresh the code
          }
        }, 1000);
      }

      function updateProgressBar(remaining) {
        const fraction = remaining / TIME_STEP;
        progressBarElement.style.width = (fraction * 100) + "%";
      }

      /*******************
       * FETCH CODE
       *******************/
      function callLambda() {
        // Clear the code box first (instead of "Loading...")
        codeText.textContent = "";

        const userPassword = passwordInput.value.trim();

        fetch("https://wyhhgjheonwo46fxqwwvt5f7li0mtkfc.lambda-url.us-east-1.on.aws/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: userPassword })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error("Network response was not ok: " + response.status);
          }
          return response.json();
        })
        .then(data => {
          // Put the code in the box
          codeText.textContent = data.code || "No code in response";
          // Restart the timer
          startTimer();
        })
        .catch(error => {
          console.error("Error:", error);
          codeText.textContent = "Error fetching code";
          // Optionally, stop the timer if there's an error
          clearInterval(countdownInterval);
          updateProgressBar(0);
        });
      }

      /*******************
       * COPY BEHAVIOR
       *******************/
      function copyToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text)
          .then(() => {
            console.log("Copied to clipboard:", text);
          })
          .catch(err => {
            console.error("Failed to copy:", err);
          });
      }

      // Clicking the code box itself copies it
      codeBox.addEventListener("click", () => {
        copyToClipboard(codeText.textContent.trim());
      });

      // Copy button also copies it
      copyBtn.addEventListener("click", () => {
        copyToClipboard(codeText.textContent.trim());
      });

      /*******************
       * RELOAD BUTTON
       *******************/
      reloadBtn.addEventListener("click", callLambda);

      /*******************
       * INITIAL LOAD
       *******************/
      callLambda(); // Grab the code when the page first loads
    </script>
  </body>
</html>