<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Mailing List vs. Unsubscribe Checker</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 40px;
			background: #f5f5f5;
		}

		h1 {
			margin-bottom: 10px;
		}

		.drop-zone {
			width: 300px;
			height: 120px;
			border: 3px dashed #cccccc;
			border-radius: 10px;
			display: flex;
			justify-content: center;
			align-items: center;
			font-size: 14px;
			color: #666666;
			background: #ffffff;
			margin-bottom: 10px;
			cursor: pointer;
			transition: border-color 0.3s, background-color 0.3s;
			text-align: center;
			padding: 10px;
		}

		.drop-zone.drag-over {
			border-color: #8888ff;
			background-color: #fafaff;
		}

		.inputs-container {
			display: flex;
			gap: 40px;
			margin-bottom: 20px;
			flex-wrap: wrap;
		}

		.drop-zone-label {
			margin-bottom: 5px;
			font-weight: bold;
		}

		#output p {
			background: #fff;
			padding: 6px 10px;
			margin: 5px 0;
			border-radius: 4px;
		}

		button {
			padding: 10px 15px;
			background: #4CAF50;
			color: #fff;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			margin-right: 10px;
		}

		button:hover {
			background: #45a049;
		}

		#pastCalculationsTable {
			border-collapse: collapse;
			margin-top: 20px;
			background: #fff;
		}

		#pastCalculationsTable th,
		#pastCalculationsTable td {
			border: 1px solid #ccc;
			padding: 5px 10px;
		}

		#pastCalculationsTable th {
			background: #eaeaea;
		}
	</style>
</head>

<body>
	<h1>Mailing List vs. Unsubscribe Checker</h1>

	<!-- File selection areas -->
	<div class="inputs-container">
		<!-- Mailing List -->
		<div>
			<div class="drop-zone-label">Mailing list CSV</div>
			<div class="drop-zone" id="mailingListDropZone">
				Drop file here or click to select
			</div>
			<input type="file" id="mailingListFile" accept=".csv" style="display:none" />
		</div>

		<!-- Unsubscribes -->
		<div>
			<div class="drop-zone-label">Unsubscribe CSV</div>
			<div class="drop-zone" id="unsubscribesDropZone">
				Drop file here or click to select
			</div>
			<input type="file" id="unsubscribesFile" accept=".csv" style="display:none" />
		</div>
	</div>

	<!-- Action buttons -->
	<button id="processButton">Process</button>
	<button id="saveButton">Save to Local Storage</button>

	<!-- Calculation output -->
	<div id="output" style="margin-top:20px;"></div>

	<!-- Past calculations table -->
	<h2>Past Calculations</h2>
	<table id="pastCalculationsTable">
		<thead>
			<tr>
				<th>Date</th>
				<th>Mailing List Count</th>
				<th>Unsubscribe List Count</th>
				<th>Number Unsubscribed</th>
				<th>Still Subscribed</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<script>
		let mailingListFileRef = null;
		let unsubscribesFileRef = null;

		// We'll store the most recent calculation results here
		let lastCalculation = null;

		window.addEventListener("DOMContentLoaded", () => {
			// Set up drag-and-drop areas
			setupDropZone("mailingListDropZone", "mailingListFile", file => {
				mailingListFileRef = file;
			});
			setupDropZone("unsubscribesDropZone", "unsubscribesFile", file => {
				unsubscribesFileRef = file;
			});

			// Hook up the buttons
			document.getElementById("processButton").addEventListener("click", processFiles);
			document.getElementById("saveButton").addEventListener("click", saveToLocalStorage);

			// On load, display any past calculations from local storage
			loadPastCalculations();
		});

		function setupDropZone(dropZoneId, fileInputId, onFilePicked) {
			const dropZone = document.getElementById(dropZoneId);
			const fileInput = document.getElementById(fileInputId);

			dropZone.addEventListener("click", () => fileInput.click());

			fileInput.addEventListener("change", e => {
				if (e.target.files && e.target.files.length > 0) {
					onFilePicked(e.target.files[0]);
					dropZone.textContent = e.target.files[0].name;
				}
			});

			dropZone.addEventListener("dragover", e => {
				e.preventDefault();
				dropZone.classList.add("drag-over");
			});
			dropZone.addEventListener("dragleave", () => {
				dropZone.classList.remove("drag-over");
			});
			dropZone.addEventListener("drop", e => {
				e.preventDefault();
				dropZone.classList.remove("drag-over");
				if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
					onFilePicked(e.dataTransfer.files[0]);
					fileInput.files = e.dataTransfer.files;
					dropZone.textContent = e.dataTransfer.files[0].name;
				}
			});
		}

		function processFiles() {
			if (!mailingListFileRef || !unsubscribesFileRef) {
				alert("Please choose both the mailing list and the unsubscribe CSV first.");
				return;
			}

			readCsvFile(mailingListFileRef, function (mailingListData) {
				readCsvFile(unsubscribesFileRef, function (unsubscribesData) {
					// Extract emails
					const mailingListEmails = extractEmails(mailingListData, "EMAIL");
					const unsubEmails = extractEmails(unsubscribesData, "email");

					// Counts
					const mailingListCount = mailingListEmails.length;
					const unsubCount = unsubEmails.length;
					const unsubscribedCount = mailingListEmails.filter(x => unsubEmails.includes(x)).length;
					const stillSubscribed = mailingListCount - unsubscribedCount;

					// Display the results
					const outDiv = document.getElementById("output");
					outDiv.innerHTML = `
            <p>Mailing list count: <strong>${mailingListCount}</strong></p>
            <p>Unsubscribe list count: <strong>${unsubCount}</strong></p>
            <p>Number unsubscribed: <strong>${unsubscribedCount}</strong></p>
            <p>Still subscribed: <strong>${stillSubscribed}</strong></p>
          `;

					// Store them in a global object so we can save them
					lastCalculation = {
						date: new Date().toLocaleString(),
						mailingListCount,
						unsubCount,
						unsubscribedCount,
						stillSubscribed
					};
				});
			});
		}

		function saveToLocalStorage() {
			if (!lastCalculation) {
				alert("No calculation results to save. Please run 'Process' first.");
				return;
			}

			// Fetch existing data from local storage (or an empty array if none)
			let allCalcs = JSON.parse(localStorage.getItem("pastCalculations")) || [];
			// Add the newest one
			allCalcs.push(lastCalculation);
			// Save back
			localStorage.setItem("pastCalculations", JSON.stringify(allCalcs));

			// Also add this row to the table
			addCalculationToTable(lastCalculation);
		}

		function loadPastCalculations() {
			const allCalcs = JSON.parse(localStorage.getItem("pastCalculations")) || [];
			allCalcs.forEach(calc => addCalculationToTable(calc));
		}

		function addCalculationToTable(calc) {
			const tbody = document.querySelector("#pastCalculationsTable tbody");
			const tr = document.createElement("tr");
			tr.innerHTML = `
        <td>${calc.date}</td>
        <td>${calc.mailingListCount}</td>
        <td>${calc.unsubCount}</td>
        <td>${calc.unsubscribedCount}</td>
        <td>${calc.stillSubscribed}</td>
      `;
			tbody.appendChild(tr);
		}

		// ========== CSV Reading & Parsing ==========

		// Read the CSV file using FileReader, then parse
		function readCsvFile(file, callback) {
			const reader = new FileReader();
			reader.onload = function (e) {
				const text = e.target.result;
				const data = parseCsv(text);
				callback(data);
			};
			reader.readAsText(file);
		}

		/**
		 * A simple CSV parser that handles:
		 * - Commas as delimiters
		 * - Double quotes around fields
		 * - Escaped double quotes ("") within fields
		 */
		function parseCsv(str) {
			const rows = [];
			let row = [];
			let col = "";
			let inQuotes = false;

			for (let i = 0; i < str.length; i++) {
				const c = str[i];
				const nextC = str[i + 1];

				if (c === '"') {
					// If we see a quote, toggle inQuotes.
					// If the next char is also a quote, then it's an escaped quote
					if (inQuotes && nextC === '"') {
						col += '"';
						i++;
					} else {
						inQuotes = !inQuotes;
					}
				} else if (c === ',' && !inQuotes) {
					row.push(col);
					col = "";
				} else if ((c === '\r' || c === '\n') && !inQuotes) {
					if (col || col === "") {
						row.push(col);
					}
					if (row.length > 0) {
						rows.push(row);
					}
					row = [];
					col = "";
					// If we have \r\n, skip the next char
					if (c === '\r' && nextC === '\n') {
						i++;
					}
				} else {
					col += c;
				}
			}
			// Push any trailing data
			if (col || col === "") row.push(col);
			if (row.length > 0) rows.push(row);

			return rows;
		}

		// Extract emails from a 2D array of CSV data using the given header name
		function extractEmails(csvData, headerName) {
			if (csvData.length < 2) return [];
			const headers = csvData[0].map(h => h.trim().toLowerCase());
			const idx = headers.indexOf(headerName.toLowerCase());
			if (idx === -1) return [];

			const emails = new Set();
			for (let i = 1; i < csvData.length; i++) {
				const row = csvData[i];
				if (row[idx]) {
					emails.add(row[idx].trim().toLowerCase());
				}
			}
			return Array.from(emails);
		}
	</script>
</body>

</html>